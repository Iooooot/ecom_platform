<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>订单管理 - 管理员控制面板</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 70px;
        }

        .navbar {
            background-color: #6c757d;
        }

        .navbar-brand,
        .nav-link {
            color: white !important;
        }

        .content-area {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            min-height: calc(100vh - 100px);
        }
    </style>
</head>

<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand" href="../index.html">电商平台 - 管理员面板</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="user-management.html">用户管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="order-management.html">订单管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="product-management.html">商品管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="category-management.html">分类管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="coupon-management.html">优惠券管理</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="statistics.html">数据统计</a>
                    </li>
                </ul>
                <div class="d-flex">
                    <div class="dropdown">
                        <button class="btn btn-light dropdown-toggle d-flex align-items-center" type="button"
                            id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor"
                                class="bi bi-person-circle me-1" viewBox="0 0 16 16">
                                <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0z" />
                                <path fill-rule="evenodd"
                                    d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1z" />
                            </svg>
                            <span id="username">管理员</span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                            <li><a class="dropdown-item" href="../account-info.html">账户信息</a></li>
                            <li><a class="dropdown-item" href="../security.html">安全设置</a></li>
                            <li>
                                <hr class="dropdown-divider">
                            </li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">退出登录</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="alertContainer"></div>

        <div class="content-area">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4>订单管理</h4>
            </div>

            <!-- 筛选表单 -->
            <div class="card mb-4">
                <div class="card-body">
                    <form id="orderFilterForm">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label for="keyword" class="form-label">关键字</label>
                                <input type="text" class="form-control" id="keyword" placeholder="订单号/用户名/商品名">
                            </div>
                            <div class="col-md-3">
                                <label for="status" class="form-label">订单状态</label>
                                <select class="form-select" id="status">
                                    <option value="">全部</option>
                                    <option value="0">待支付</option>
                                    <option value="1">已支付</option>
                                    <option value="2">已发货</option>
                                    <option value="3">已完成</option>
                                    <option value="4">已取消</option>
                                    <option value="5">已退款</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="startTime" class="form-label">开始日期</label>
                                <input type="date" class="form-control" id="startTime">
                            </div>
                            <div class="col-md-3">
                                <label for="endTime" class="form-label">结束日期</label>
                                <input type="date" class="form-control" id="endTime">
                            </div>
                            <div class="col-12 text-end">
                                <button type="button" class="btn btn-secondary" id="resetBtn">重置</button>
                                <button type="button" class="btn btn-primary" id="searchBtn">搜索</button>
                                <button type="button" class="btn btn-warning ms-2" id="refundReviewBtn">
                                    <i class="bi bi-cash-coin"></i> 退款审核
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <!-- 订单列表 -->
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>订单ID</th>
                            <th>用户ID</th>
                            <th>金额</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>支付方式</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        <tr>
                            <td colspan="7" class="text-center py-4">
                                <div class="spinner-border text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="mt-2">正在加载订单数据...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- 分页控件 -->
            <nav aria-label="订单列表分页" class="mt-4">
                <ul class="pagination justify-content-center" id="orderPagination">
                </ul>
            </nav>
        </div>
    </div>

    <!-- 订单详情模态框 -->
    <div class="modal fade" id="orderDetailModal" tabindex="-1" aria-labelledby="orderDetailModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="orderDetailModalLabel">订单详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="orderDetailContent">
                    <div class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">正在加载订单详情...</p>
                    </div>
                </div>
                <div class="modal-footer d-block">
                    <div class="row mb-3" id="shippingInfoContainer" style="display: none;">
                        <div class="col-md-8">
                            <div class="input-group">
                                <span class="input-group-text">物流单号</span>
                                <input type="text" class="form-control" id="trackingNumber" placeholder="请输入物流单号">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <select class="form-select" id="shippingCompany">
                                <option value="">选择物流公司</option>
                                <option value="顺丰快递">顺丰快递</option>
                                <option value="中通快递">中通快递</option>
                                <option value="圆通快递">圆通快递</option>
                                <option value="申通快递">申通快递</option>
                                <option value="韵达快递">韵达快递</option>
                                <option value="邮政EMS">邮政EMS</option>
                                <option value="京东物流">京东物流</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                    </div>
                    <div class="text-end">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                        <button type="button" class="btn btn-primary" id="markShippedBtn">标记为已发货</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 退款审核模态框 -->
    <div class="modal fade" id="refundReviewModal" tabindex="-1" aria-labelledby="refundReviewModalLabel"
        aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="refundReviewModalLabel">退款申请审核</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 筛选表单 -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <form id="refundFilterForm" class="row g-3">
                                <div class="col-md-3">
                                    <label for="refundKeyword" class="form-label">关键字</label>
                                    <input type="text" class="form-control" id="refundKeyword" placeholder="订单号/用户ID">
                                </div>
                                <div class="col-md-3">
                                    <label for="refundStatus" class="form-label">退款状态</label>
                                    <select class="form-select" id="refundStatus">
                                        <option value="">全部</option>
                                        <option value="0">待审核</option>
                                        <option value="1">已批准</option>
                                        <option value="2">已拒绝</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label for="refundStartTime" class="form-label">开始日期</label>
                                    <input type="date" class="form-control" id="refundStartTime">
                                </div>
                                <div class="col-md-3">
                                    <label for="refundEndTime" class="form-label">结束日期</label>
                                    <input type="date" class="form-control" id="refundEndTime">
                                </div>
                                <div class="col-12 text-end">
                                    <button type="button" class="btn btn-secondary" id="resetRefundBtn">重置</button>
                                    <button type="button" class="btn btn-primary" id="searchRefundBtn">搜索</button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- 退款申请列表 -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>申请ID</th>
                                    <th>订单ID</th>
                                    <th>用户ID</th>
                                    <th>退款金额</th>
                                    <th>申请原因</th>
                                    <th>申请时间</th>
                                    <th>状态</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="refundTableBody">
                                <tr>
                                    <td colspan="8" class="text-center py-4">
                                        <div class="spinner-border text-secondary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2">正在加载退款申请数据...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- 分页控件 -->
                    <nav aria-label="退款申请列表分页" class="mt-4">
                        <ul class="pagination justify-content-center" id="refundPagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- 退款处理模态框 -->
    <div class="modal fade" id="processRefundModal" tabindex="-1" aria-labelledby="processRefundModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="processRefundModalLabel">处理退款申请</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="processRefundForm">
                        <input type="hidden" id="refundId">
                        <input type="hidden" id="refundOrderId">

                        <div class="mb-3">
                            <label class="form-label">订单ID</label>
                            <p id="processRefundOrderId" class="form-control-plaintext"></p>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">用户ID</label>
                            <p id="processRefundUserId" class="form-control-plaintext"></p>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">申请退款金额</label>
                            <p id="processRefundAmount" class="form-control-plaintext"></p>
                        </div>

                        <div class="mb-3" id="actualRefundAmountGroup">
                            <label for="actualRefundAmount" class="form-label">实际退款金额</label>
                            <div class="input-group">
                                <span class="input-group-text">¥</span>
                                <input type="number" class="form-control" id="actualRefundAmount" step="0.01" min="0">
                            </div>
                            <div class="form-text">批准退款时，可修改实际退款金额</div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">申请原因</label>
                            <p id="processRefundReason" class="form-control-plaintext"></p>
                        </div>

                        <div class="mb-3">
                            <label for="processRefundStatus" class="form-label">处理结果</label>
                            <select class="form-select" id="processRefundStatus" required>
                                <option value="">请选择</option>
                                <option value="APPROVED">批准退款</option>
                                <option value="REJECTED">拒绝退款</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="processRefundRemarks" class="form-label">处理备注</label>
                            <textarea class="form-control" id="processRefundRemarks" rows="3"
                                placeholder="请输入处理备注"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submitProcessRefundBtn">提交</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="../js/auth-helper.js"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function () {
            // 初始化认证
            AuthHelper.init();

            // 验证管理员权限
            checkAdminRole();

            // 加载订单列表
            loadOrders(1);

            // 搜索按钮点击事件
            document.getElementById('searchBtn').addEventListener('click', function () {
                loadOrders(1);
            });

            // 重置按钮点击事件
            document.getElementById('resetBtn').addEventListener('click', function () {
                document.getElementById('orderFilterForm').reset();
                loadOrders(1);
            });

            // 标记发货按钮
            document.getElementById('markShippedBtn').addEventListener('click', markOrderAsShipped);

            // 退出登录按钮
            document.getElementById('logoutBtn').addEventListener('click', AuthHelper.logout);

            // 退款审核按钮
            document.getElementById('refundReviewBtn').addEventListener('click', openRefundReviewModal);

            // 退款搜索按钮
            document.getElementById('searchRefundBtn').addEventListener('click', function () {
                loadRefunds(1);
            });

            // 退款重置按钮
            document.getElementById('resetRefundBtn').addEventListener('click', function () {
                document.getElementById('refundFilterForm').reset();
                loadRefunds(1);
            });

            // 提交退款处理按钮
            document.getElementById('submitProcessRefundBtn').addEventListener('click', submitRefundProcess);
        });

        // 验证是否是管理员
        function checkAdminRole() {
            const userRole = localStorage.getItem('userRole');
            if (userRole !== '2') {
                // 不是管理员，跳转到首页
                window.location.href = '../index.html';
                showAlert('error', '您没有管理员权限');
            }
        }

        // 加载订单列表
        function loadOrders(page) {
            console.log('加载订单页面:', page);

            // 获取筛选条件
            const queryDTO = {
                keyword: document.getElementById('keyword').value || null,
                status: document.getElementById('status').value || null,
                startTime: document.getElementById('startTime').value || null,
                endTime: document.getElementById('endTime').value || null,
                pageNum: parseInt(page) || 1,
                pageSize: 10
            };

            // 显示加载状态
            document.getElementById('orderTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">正在加载第 ${queryDTO.pageNum} 页订单数据...</p>
                    </td>
                </tr>
            `;

            // 移除null值
            Object.keys(queryDTO).forEach(key => {
                if (queryDTO[key] === null) {
                    delete queryDTO[key];
                }
            });

            console.log('发送请求参数:', queryDTO);

            axios.post('/api/admin/orders/list', queryDTO)
                .then(response => {
                    console.log('订单API响应:', response.data);

                    if (response.data.code === 200) {
                        const ordersData = response.data.data;
                        if (!ordersData || !ordersData.records) {
                            document.getElementById('orderTableBody').innerHTML = `
                                <tr>
                                    <td colspan="7" class="text-center">没有找到订单数据</td>
                                </tr>
                            `;
                            // 清空分页
                            document.getElementById('orderPagination').innerHTML = '';
                            return;
                        }

                        console.log('订单列表数据:', ordersData);
                        console.log('当前页:', ordersData.current, '总页数:', ordersData.pages, '总记录数:', ordersData.total);

                        // 处理每个订单的用户信息
                        ordersData.records.forEach(order => {
                            // 处理用户信息
                            if (order.user && typeof order.user === 'object') {
                                // 优先使用用户对象中的用户ID
                                order.userId = order.user.userId || order.user.id || order.userId;
                            }

                            // 确保有用户ID，即使没有用户对象
                            if (!order.userId) {
                                console.warn('订单缺少用户ID:', order.orderId);
                            }
                        });

                        // 使用正确的当前页码
                        const currentPage = ordersData.current || queryDTO.pageNum;
                        renderOrders(ordersData.records, currentPage, ordersData.pages || 1);
                    } else {
                        document.getElementById('orderTableBody').innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center">加载订单失败: ${response.data.message}</td>
                            </tr>
                        `;
                        // 清空分页
                        document.getElementById('orderPagination').innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('加载订单失败:', error);
                    document.getElementById('orderTableBody').innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center">加载订单失败，请稍后重试</td>
                        </tr>
                    `;
                    // 清空分页
                    document.getElementById('orderPagination').innerHTML = '';
                });
        }

        // 渲染订单列表
        function renderOrders(orders, currentPage, totalPages) {
            const tableBody = document.getElementById('orderTableBody');
            tableBody.innerHTML = '';

            if (orders.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center">没有找到订单</td>
                    </tr>
                `;
                return;
            }

            orders.forEach(order => {
                // 设置状态标签样式
                let statusClass = '';
                let statusText = '';

                switch (order.status) {
                    case 0:
                        statusClass = 'bg-warning';
                        statusText = '待支付';
                        break;
                    case 1:
                        statusClass = 'bg-info';
                        statusText = '已支付';
                        break;
                    case 2:
                        statusClass = 'bg-primary';
                        statusText = '已发货';
                        break;
                    case 3:
                        statusClass = 'bg-success';
                        statusText = '已完成';
                        break;
                    case 4:
                        statusClass = 'bg-danger';
                        statusText = '已取消';
                        break;
                    case 5:
                        statusClass = 'bg-dark';
                        statusText = '已退款';
                        break;
                    default:
                        statusClass = 'bg-secondary';
                        statusText = '未知';
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${order.orderId}</td>
                    <td>${order.userId || '未知用户ID'}</td>
                    <td>¥${order.totalAmount?.toFixed(2)}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>${new Date(order.createTime).toLocaleString()}</td>
                    <td>${order.paymentMethod || '平台支付'}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-order" data-id="${order.orderId}">
                            <i class="bi bi-eye"></i> 查看
                        </button>
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // 绑定查看按钮事件
            document.querySelectorAll('.view-order').forEach(btn => {
                btn.addEventListener('click', function () {
                    const orderId = this.getAttribute('data-id');
                    openOrderDetail(orderId);
                });
            });

            // 更新分页
            renderPagination(currentPage, totalPages);
        }

        // 渲染分页控件
        function renderPagination(currentPage, totalPages) {
            console.log('渲染分页控件 - 当前页:', currentPage, '总页数:', totalPages);

            // 确保参数是数字
            currentPage = parseInt(currentPage) || 1;
            totalPages = parseInt(totalPages) || 1;

            const pagination = document.getElementById('orderPagination');
            pagination.innerHTML = '';

            // 如果总页数小于等于1，不显示分页
            if (totalPages <= 1) {
                console.log('总页数小于等于1，不显示分页');
                return;
            }

            // 创建一个简单的分页控件，避免过多的DOM操作
            let paginationHTML = '';

            // 上一页按钮
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="${currentPage > 1 ? `loadOrders(${currentPage - 1})` : ''}">上一页</a>
                </li>
            `;

            // 第一页按钮（如果不在显示范围内）
            const maxPages = 5; // 最多显示5个页码
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages && startPage > 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="javascript:void(0)" onclick="loadOrders(1)">1</a>
                    </li>
                `;

                if (startPage > 2) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="javascript:void(0)">...</a>
                        </li>
                    `;
                }
            }

            // 页码按钮
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" ${i !== currentPage ? `onclick="loadOrders(${i})"` : ''}>${i}</a>
                    </li>
                `;
            }

            // 最后一页按钮（如果不在显示范围内）
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="javascript:void(0)">...</a>
                        </li>
                    `;
                }

                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="javascript:void(0)" onclick="loadOrders(${totalPages})">${totalPages}</a>
                    </li>
                `;
            }

            // 下一页按钮
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="${currentPage < totalPages ? `loadOrders(${currentPage + 1})` : ''}">下一页</a>
                </li>
            `;

            // 设置HTML
            pagination.innerHTML = paginationHTML;

            // 添加调试信息
            console.log('分页控件已渲染，当前页:', currentPage, '总页数:', totalPages);
        }

        // 打开订单详情模态框
        function openOrderDetail(orderId) {
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('orderDetailModal'));
            modal.show();

            // 重置详情内容
            document.getElementById('orderDetailContent').innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-secondary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">正在加载订单详情...</p>
                </div>
            `;

            // 加载订单详情
            axios.get(`/api/admin/orders/${orderId}`)
                .then(response => {
                    if (response.data.code === 200) {
                        const order = response.data.data;
                        console.log('原始订单数据:', response.data);

                        // 处理可能的嵌套数据结构
                        if (order.user && typeof order.user === 'object') {
                            // 如果用户信息是嵌套的对象，提取用户ID到顶层
                            order.userId = order.user.userId || order.user.id || order.userId;
                        }

                        // 确保有用户ID
                        if (!order.userId) {
                            console.warn('订单详情缺少用户ID:', orderId);
                            order.userId = '未知用户ID';
                        }

                        // 处理收货地址信息
                        if (order.address && typeof order.address === 'object') {
                            // 如果收货信息是嵌套的对象，提取到顶层
                            order.receiverName = order.address.name || order.address.recipientName;
                            order.receiverPhone = order.address.phone || order.address.receiverPhone;
                            order.receiverAddress = order.address.address || order.address.country + order.address.state + order.address.city + order.address.addressLine1 + order.address.addressLine2;
                        }

                        renderOrderDetail(order);
                    } else {
                        document.getElementById('orderDetailContent').innerHTML = `
                            <div class="alert alert-danger">
                                加载订单详情失败: ${response.data.message}
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    console.error('加载订单详情失败:', error);
                    document.getElementById('orderDetailContent').innerHTML = `
                        <div class="alert alert-danger">
                            加载订单详情失败，请稍后重试
                        </div>
                    `;
                });
        }

        // 渲染订单详情
        function renderOrderDetail(order) {
            // 输出订单数据结构，便于调试
            console.log('订单详情数据:', JSON.stringify(order, null, 2));

            // 获取订单状态文本和样式
            let statusText = '';
            let statusClass = '';
            switch (order.status) {
                case 0:
                    statusText = '待支付';
                    statusClass = 'bg-warning';
                    break;
                case 1:
                    statusText = '已支付';
                    statusClass = 'bg-info';
                    break;
                case 2:
                    statusText = '已发货';
                    statusClass = 'bg-primary';
                    break;
                case 3:
                    statusText = '已完成';
                    statusClass = 'bg-success';
                    break;
                case 4:
                    statusText = '已取消';
                    statusClass = 'bg-danger';
                    break;
                case 5:
                    statusText = '已退款';
                    statusClass = 'bg-dark';
                    break;
                default:
                    statusText = '未知';
                    statusClass = 'bg-secondary';
            }

            // 控制按钮和物流信息输入区域显示状态
            const markShippedBtn = document.getElementById('markShippedBtn');
            const shippingInfoContainer = document.getElementById('shippingInfoContainer');
            if (order.status === 1) {
                markShippedBtn.style.display = 'block';
                markShippedBtn.setAttribute('data-id', order.orderId);
                shippingInfoContainer.style.display = 'flex';
            } else {
                markShippedBtn.style.display = 'none';
                shippingInfoContainer.style.display = 'none';
            }

            // 构建详情HTML
            let detailHtml = `
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6>基本信息</h6>
                        <table class="table table-sm">
                            <tr>
                                <th>订单ID</th>
                                <td>${order.orderId}</td>
                            </tr>
                            <tr>
                                <th>用户ID</th>
                                <td>${order.userId || '未知用户ID'}</td>
                            </tr>
                            <tr>
                                <th>订单状态</th>
                                <td><span class="badge ${statusClass}">${statusText}</span></td>
                            </tr>
                            <tr>
                                <th>创建时间</th>
                                <td>${new Date(order.createTime).toLocaleString()}</td>
                            </tr>
                            <tr>
                                <th>支付方式</th>
                                <td>${order.paymentMethod || '平台支付'}</td>
                            </tr>
                            ${order.payTime ? `<tr>
                                <th>支付时间</th>
                                <td>${new Date(order.payTime).toLocaleString()}</td>
                            </tr>` : ''}
                            ${order.shipTime ? `<tr>
                                <th>发货时间</th>
                                <td>${new Date(order.shipTime).toLocaleString()}</td>
                            </tr>` : ''}
                            ${order.trackingNumber ? `<tr>
                                <th>物流单号</th>
                                <td>${order.trackingNumber}</td>
                            </tr>` : ''}
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h6>收货信息</h6>
                        <div id="shippingInfoLoading">
                            <div class="d-flex justify-content-center align-items-center" style="height: 100px;">
                                <div class="spinner-border text-secondary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <p class="ms-2 mb-0">正在加载收货信息...</p>
                            </div>
                        </div>
                        <div id="shippingInfoContent" style="display: none;">
                            <table class="table table-sm">
                                <tr>
                                    <th>收货人</th>
                                    <td id="receiverName">未提供</td>
                                </tr>
                                <tr>
                                    <th>联系电话</th>
                                    <td id="receiverPhone">未提供</td>
                                </tr>
                                <tr>
                                    <th>收货地址</th>
                                    <td id="receiverAddress">未提供</td>
                                </tr>
                                <tr>
                                    <th>邮政编码</th>
                                    <td id="postalCode">未提供</td>
                                </tr>
                                <tr id="defaultAddressRow" style="display: none;">
                                    <th>默认地址</th>
                                    <td><span class="badge bg-success">是</span></td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                
                <h6>订单商品</h6>
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>商品ID</th>
                                <th>商品名称</th>
                                <th>单价</th>
                                <th>数量</th>
                                <th>小计</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // 添加订单项
            if (order.orderItems && order.orderItems.length > 0) {
                order.orderItems.forEach(item => {
                    detailHtml += `
                        <tr>
                            <td>${item.productId}</td>
                            <td>${item.productName || '未知商品'}</td>
                            <td>¥${item.price?.toFixed(2)}</td>
                            <td>${item.quantity}</td>
                            <td>¥${(item.price * item.quantity).toFixed(2)}</td>
                        </tr>
                    `;
                });
            } else {
                detailHtml += `
                    <tr>
                        <td colspan="5" class="text-center">没有商品信息</td>
                    </tr>
                `;
            }

            detailHtml += `
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="4" class="text-end">总计:</th>
                                <th>¥${order.totalAmount?.toFixed(2)}</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="mt-3">
                    <h6>备注</h6>
                    <div class="form-floating">
                        <textarea class="form-control" id="adminRemarks" style="height: 100px">${order.adminRemarks || ''}</textarea>
                        <label for="adminRemarks">管理员备注</label>
                    </div>
                    <div class="d-flex justify-content-end mt-2">
                        <button class="btn btn-primary btn-sm" onclick="saveAdminRemarks('${order.orderId}')">保存备注</button>
                    </div>
                </div>
            `;

            document.getElementById('orderDetailContent').innerHTML = detailHtml;

            // 加载收货地址信息
            loadShippingInfo(order.orderId);
        }

        // 加载收货地址信息
        function loadShippingInfo(orderId) {
            // 显示加载中状态
            document.getElementById('shippingInfoLoading').style.display = 'block';
            document.getElementById('shippingInfoContent').style.display = 'none';

            // 发送请求获取订单详情
            axios.get(`/api/admin/orders/${orderId}`)
                .then(response => {
                    // 隐藏加载中状态
                    document.getElementById('shippingInfoLoading').style.display = 'none';
                    document.getElementById('shippingInfoContent').style.display = 'block';

                    console.log('订单详情API响应:', response.data);

                    if (response.data.code === 200) {
                        const orderDetail = response.data.data;

                        // 检查是否有address对象
                        if (orderDetail.address && typeof orderDetail.address === 'object') {
                            const address = orderDetail.address;
                            console.log('收货地址信息:', address);

                            // 提取收货人信息
                            const recipientName = address.recipientName || '';

                            // 提取电话信息
                            const phone = address.phone || address.mobile || '';

                            // 构建完整地址
                            let fullAddress = '';
                            if (address.country) fullAddress += address.country;
                            if (address.state) fullAddress += ' ' + address.state;
                            if (address.city) fullAddress += ' ' + address.city;
                            if (address.addressLine1) fullAddress += ' ' + address.addressLine1;
                            if (address.addressLine2) fullAddress += ' ' + address.addressLine2;
                            if (address.postalCode) fullAddress += ' (' + address.postalCode + ')';

                            // 更新收货信息
                            document.getElementById('receiverName').textContent = recipientName || '未提供';
                            document.getElementById('receiverPhone').textContent = phone || '未提供';
                            document.getElementById('receiverAddress').textContent = fullAddress.trim() || '未提供';

                            // 更新邮政编码
                            if (address.postalCode) {
                                document.getElementById('postalCode').textContent = address.postalCode;
                            } else {
                                document.getElementById('postalCode').textContent = '未提供';
                            }

                            // 显示是否为默认地址
                            if (address.isDefault === true) {
                                document.getElementById('defaultAddressRow').style.display = '';
                            } else {
                                document.getElementById('defaultAddressRow').style.display = 'none';
                            }
                        } else {
                            // 尝试从订单对象中直接获取收货信息
                            console.log('尝试从订单对象中直接获取收货信息');

                            // 尝试从不同可能的字段名中获取收货信息
                            const receiverName = extractValue(orderDetail, ['receiverName', 'recipientName', 'name', 'consignee']);
                            const receiverPhone = extractValue(orderDetail, ['receiverPhone', 'recipientPhone', 'phone', 'mobile', 'tel']);
                            const receiverAddress = extractValue(orderDetail, ['receiverAddress', 'recipientAddress', 'fullAddress', 'detailAddress']);

                            // 更新收货信息
                            document.getElementById('receiverName').textContent = receiverName || '未提供';
                            document.getElementById('receiverPhone').textContent = receiverPhone || '未提供';
                            document.getElementById('receiverAddress').textContent = receiverAddress || '未提供';
                        }
                    } else {
                        console.error('加载订单详情失败:', response.data.message);
                        showErrorShippingInfo();
                    }
                })
                .catch(error => {
                    console.error('加载订单详情失败:', error);

                    // 尝试使用专门的收货地址API
                    console.log('尝试使用专门的收货地址API...');
                    axios.get(`/api/admin/orders/${orderId}/shipping-info`)
                        .then(response => {
                            if (response.data.code === 200) {
                                const shippingInfo = response.data.data;
                                console.log('收货地址API响应:', shippingInfo);

                                // 检查是否有address对象
                                if (shippingInfo.address && typeof shippingInfo.address === 'object') {
                                    const address = shippingInfo.address;

                                    // 提取收货人信息
                                    const recipientName = address.recipientName || '';

                                    // 提取电话信息
                                    const phone = address.phone || address.mobile || '';

                                    // 构建完整地址
                                    let fullAddress = '';
                                    if (address.country) fullAddress += address.country;
                                    if (address.state) fullAddress += ' ' + address.state;
                                    if (address.city) fullAddress += ' ' + address.city;
                                    if (address.addressLine1) fullAddress += ' ' + address.addressLine1;
                                    if (address.addressLine2) fullAddress += ' ' + address.addressLine2;
                                    if (address.postalCode) fullAddress += ' (' + address.postalCode + ')';

                                    // 更新收货信息
                                    document.getElementById('receiverName').textContent = recipientName || '未提供';
                                    document.getElementById('receiverPhone').textContent = phone || '未提供';
                                    document.getElementById('receiverAddress').textContent = fullAddress.trim() || '未提供';

                                    // 更新邮政编码
                                    if (address.postalCode) {
                                        document.getElementById('postalCode').textContent = address.postalCode;
                                    } else {
                                        document.getElementById('postalCode').textContent = '未提供';
                                    }

                                    // 显示是否为默认地址
                                    if (address.isDefault === true) {
                                        document.getElementById('defaultAddressRow').style.display = '';
                                    } else {
                                        document.getElementById('defaultAddressRow').style.display = 'none';
                                    }
                                } else {
                                    // 尝试从不同可能的字段名中获取收货信息
                                    const receiverName = extractValue(shippingInfo, ['receiverName', 'recipientName', 'name', 'consignee']);
                                    const receiverPhone = extractValue(shippingInfo, ['receiverPhone', 'recipientPhone', 'phone', 'mobile', 'tel']);
                                    const receiverAddress = extractValue(shippingInfo, ['receiverAddress', 'recipientAddress', 'address', 'fullAddress', 'detailAddress']);

                                    // 更新收货信息
                                    document.getElementById('receiverName').textContent = receiverName || '未提供';
                                    document.getElementById('receiverPhone').textContent = receiverPhone || '未提供';
                                    document.getElementById('receiverAddress').textContent = receiverAddress || '未提供';
                                }
                            } else {
                                showErrorShippingInfo();
                            }
                        })
                        .catch(() => {
                            showErrorShippingInfo();
                        });
                });
        }

        // 从对象中提取值，尝试多个可能的键名
        function extractValue(obj, keys) {
            if (!obj || typeof obj !== 'object') return null;

            // 尝试直接从对象中获取值
            for (const key of keys) {
                if (obj[key]) return obj[key];
            }

            // 尝试从嵌套对象中获取值
            for (const key in obj) {
                if (typeof obj[key] === 'object' && obj[key] !== null) {
                    const nestedValue = extractValue(obj[key], keys);
                    if (nestedValue) return nestedValue;
                }
            }

            return null;
        }

        // 显示收货地址加载错误信息
        function showErrorShippingInfo() {
            // 隐藏加载中状态
            document.getElementById('shippingInfoLoading').style.display = 'none';
            document.getElementById('shippingInfoContent').style.display = 'block';

            // 显示错误信息
            document.getElementById('receiverName').textContent = '加载失败';
            document.getElementById('receiverPhone').textContent = '加载失败';
            document.getElementById('receiverAddress').textContent = '加载失败';
            document.getElementById('postalCode').textContent = '加载失败';
            document.getElementById('defaultAddressRow').style.display = 'none';
        }

        // 保存管理员备注
        function saveAdminRemarks(orderId) {
            const remarks = document.getElementById('adminRemarks').value;
            
            // 获取当前订单状态 - 从页面已渲染的订单状态中获取
            let currentStatus = null;
            const statusElement = document.querySelector('#orderDetailContent table tr:nth-child(3) td span');
            if (statusElement) {
                const statusText = statusElement.textContent.trim();
                // 根据状态文本确定状态值
                switch (statusText) {
                    case '待支付': currentStatus = 0; break;
                    case '已支付': currentStatus = 1; break;
                    case '已发货': currentStatus = 2; break;
                    case '已完成': currentStatus = 3; break;
                    case '已取消': currentStatus = 4; break;
                    case '已退款': currentStatus = 5; break;
                    default: currentStatus = 0;
                }
            }
            
            // 如果无法获取状态，先重新请求订单详情
            if (currentStatus === null) {
                axios.get(`/api/admin/orders/${orderId}`)
                    .then(response => {
                        if (response.data.code === 200) {
                            const orderData = response.data.data;
                            currentStatus = orderData.status || 0;
                            // 获取状态后再保存备注
                            updateOrderRemarks(orderId, currentStatus, remarks);
                        } else {
                            showAlert('error', '获取订单信息失败: ' + response.data.message);
                        }
                    })
                    .catch(error => {
                        console.error('获取订单信息失败:', error);
                        showAlert('error', '获取订单信息失败，请稍后重试');
                    });
            } else {
                // 直接保存备注
                updateOrderRemarks(orderId, currentStatus, remarks);
            }
        }
        
        // 更新订单备注的辅助函数
        function updateOrderRemarks(orderId, status, remarks) {
            axios.post(`/api/admin/orders/${orderId}/status?status=${status}&remarks=${encodeURIComponent(remarks)}`)
                .then(response => {
                    if (response.data.code === 200) {
                        showAlert('success', '备注保存成功');
                    } else {
                        showAlert('error', '保存备注失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('保存备注失败:', error);
                    showAlert('error', '保存备注失败，请稍后重试');
                });
        }

        // 标记订单为已发货
        function markOrderAsShipped() {
            const markShippedBtn = document.getElementById('markShippedBtn');
            const orderId = markShippedBtn.getAttribute('data-id');

            // 获取物流信息
            const trackingNumber = document.getElementById('trackingNumber').value.trim();
            const shippingCompany = document.getElementById('shippingCompany').value;

            // 显示加载状态
            const originalText = markShippedBtn.innerHTML;
            markShippedBtn.disabled = true;
            markShippedBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...`;

            // 准备发送数据
            const shipData = {
                trackingNumber: trackingNumber,
                shippingCompany: shippingCompany
            };

            axios.post(`/api/admin/orders/${orderId}/ship`, shipData)
                .then(response => {
                    if (response.data.code === 200) {
                        let successMessage = `订单 ${orderId} 已成功标记为已发货`;
                        if (trackingNumber) {
                            successMessage += `，物流单号: ${trackingNumber}`;
                            if (shippingCompany) {
                                successMessage += ` (${shippingCompany})`;
                            }
                        }
                        showAlert('success', successMessage);

                        // 更新订单状态显示
                        const statusElement = document.querySelector('#orderDetailContent table tr:nth-child(3) td span');
                        if (statusElement) {
                            statusElement.className = 'badge bg-primary';
                            statusElement.textContent = '已发货';
                        }

                        // 如果有物流信息，添加到详情中
                        if (trackingNumber) {
                            const tableBody = document.querySelector('#orderDetailContent .col-md-6:first-child table tbody');
                            if (tableBody) {
                                const now = new Date();

                                // 添加发货时间
                                const shipTimeRow = document.createElement('tr');
                                shipTimeRow.innerHTML = `
                                    <th>发货时间</th>
                                    <td>${now.toLocaleString()}</td>
                                `;
                                tableBody.appendChild(shipTimeRow);

                                // 添加物流单号
                                const trackingRow = document.createElement('tr');
                                trackingRow.innerHTML = `
                                    <th>物流单号</th>
                                    <td>${trackingNumber}${shippingCompany ? ` (${shippingCompany})` : ''}</td>
                                `;
                                tableBody.appendChild(trackingRow);
                            }
                        }

                        // 隐藏发货按钮和物流信息输入区域
                        markShippedBtn.style.display = 'none';
                        document.getElementById('shippingInfoContainer').style.display = 'none';

                        // 刷新订单列表
                        loadOrders(1);
                    } else {
                        showAlert('error', '标记发货失败: ' + response.data.message);
                        // 恢复按钮状态
                        markShippedBtn.disabled = false;
                        markShippedBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('标记发货失败:', error);
                    showAlert('error', '标记发货失败，请稍后重试');
                    // 恢复按钮状态
                    markShippedBtn.disabled = false;
                    markShippedBtn.innerHTML = originalText;
                });
        }

        // 显示提示信息
        function showAlert(type, message) {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type === 'error' ? 'danger' : 'success'} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;

            alertContainer.innerHTML = '';
            alertContainer.appendChild(alertDiv);

            // 5秒后自动关闭
            setTimeout(() => {
                alertDiv.classList.remove('show');
                setTimeout(() => {
                    if (alertContainer.contains(alertDiv)) {
                        alertContainer.removeChild(alertDiv);
                    }
                }, 150);
            }, 5000);
        }

        // 打开退款审核模态框
        function openRefundReviewModal() {
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('refundReviewModal'));
            modal.show();

            // 加载退款申请列表
            loadRefunds(1);
        }

        // 加载退款申请列表
        function loadRefunds(page) {
            console.log('加载退款申请页面:', page);

            // 获取筛选条件
            const queryDTO = {
                keyword: document.getElementById('refundKeyword').value || null,
                status: document.getElementById('refundStatus').value || null,
                startTime: document.getElementById('refundStartTime').value || null,
                endTime: document.getElementById('refundEndTime').value || null,
                pageNum: parseInt(page) || 1,
                pageSize: 10
            };

            // 移除null值
            Object.keys(queryDTO).forEach(key => {
                if (queryDTO[key] === null) {
                    delete queryDTO[key];
                }
            });

            // 显示加载中
            document.getElementById('refundTableBody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center py-4">
                        <div class="spinner-border text-secondary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2">正在加载第 ${queryDTO.pageNum} 页退款申请数据...</p>
                    </td>
                </tr>
            `;

            console.log('发送退款请求参数:', queryDTO);

            axios.post('/api/admin/orders/refunds/list', queryDTO)
                .then(response => {
                    console.log('退款API响应:', response.data);

                    if (response.data.code === 200) {
                        const refundsData = response.data.data;
                        console.log('退款申请数据:', refundsData);

                        // 处理可能的不同数据结构
                        let records = [];
                        let totalPages = 1;
                        let currentPage = queryDTO.pageNum;

                        if (refundsData && refundsData.records && Array.isArray(refundsData.records)) {
                            // 标准分页结构
                            records = refundsData.records;
                            totalPages = refundsData.pages || 1;
                            currentPage = refundsData.current || queryDTO.pageNum;
                        } else if (refundsData && Array.isArray(refundsData)) {
                            // 直接返回数组
                            records = refundsData;
                            totalPages = 1;
                        } else if (refundsData && refundsData.data && Array.isArray(refundsData.data)) {
                            // 嵌套在data字段中
                            records = refundsData.data;
                            totalPages = refundsData.pages || refundsData.totalPages || 1;
                            currentPage = refundsData.current || refundsData.pageNum || queryDTO.pageNum;
                        }

                        console.log('退款数据解析结果 - 记录数:', records.length, '总页数:', totalPages, '当前页:', currentPage);

                        // 检查是否有数据
                        if (records.length === 0) {
                            document.getElementById('refundTableBody').innerHTML = `
                                <tr>
                                    <td colspan="8" class="text-center">没有找到退款申请数据</td>
                                </tr>
                            `;
                            // 清空分页
                            document.getElementById('refundPagination').innerHTML = '';
                            return;
                        }

                        // 输出退款数据结构，便于调试
                        console.log('退款数据示例:', records.length > 0 ? records[0] : '无数据');
                        console.log('退款金额字段检查:', records.length > 0 ? {
                            amount: records[0].amount,
                            refundAmount: records[0].refundAmount,
                            money: records[0].money,
                            totalAmount: records[0].totalAmount
                        } : '无数据');

                        renderRefunds(records, currentPage, totalPages);
                    } else {
                        document.getElementById('refundTableBody').innerHTML = `
                            <tr>
                                <td colspan="8" class="text-center">加载退款申请失败: ${response.data.message}</td>
                            </tr>
                        `;
                        // 清空分页
                        document.getElementById('refundPagination').innerHTML = '';
                    }
                })
                .catch(error => {
                    console.error('加载退款申请失败:', error);
                    document.getElementById('refundTableBody').innerHTML = `
                        <tr>
                            <td colspan="8" class="text-center">加载退款申请失败，请稍后重试</td>
                        </tr>
                    `;
                    // 清空分页
                    document.getElementById('refundPagination').innerHTML = '';
                });
        }

        // 渲染退款申请列表
        function renderRefunds(refunds, currentPage, totalPages) {
            const tableBody = document.getElementById('refundTableBody');
            tableBody.innerHTML = '';

            if (refunds.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="text-center">没有找到退款申请</td>
                    </tr>
                `;
                return;
            }

            refunds.forEach(refund => {
                // 设置状态标签样式
                let statusClass = '';
                let statusText = '';

                switch (refund.status) {
                    case 0:
                        statusClass = 'bg-warning';
                        statusText = '待审核';
                        break;
                    case 1:
                        statusClass = 'bg-success';
                        statusText = '已批准';
                        break;
                    case 2:
                        statusClass = 'bg-danger';
                        statusText = '已拒绝';
                        break;
                    default:
                        statusClass = 'bg-secondary';
                        statusText = '未知';
                }

                // 处理金额显示
                let amountDisplay = '¥0.00';
                if (refund.amount !== undefined && refund.amount !== null) {
                    amountDisplay = `¥${Number(refund.amount).toFixed(2)}`;
                } else if (refund.refundAmount !== undefined && refund.refundAmount !== null) {
                    amountDisplay = `¥${Number(refund.refundAmount).toFixed(2)}`;
                }

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${refund.refundId}</td>
                    <td>${refund.orderId}</td>
                    <td>${refund.userId}</td>
                    <td>${amountDisplay}</td>
                    <td>${refund.reason || '未提供原因'}</td>
                    <td>${new Date(refund.createTime).toLocaleString()}</td>
                    <td><span class="badge ${statusClass}">${statusText}</span></td>
                    <td>
                        ${refund.status === 0 ? `
                            <button class="btn btn-sm btn-primary process-refund" data-id="${refund.refundId}">
                                处理
                            </button>
                        ` : `
                            <button class="btn btn-sm btn-outline-secondary" disabled>
                                已处理
                            </button>
                        `}
                    </td>
                `;

                tableBody.appendChild(row);
            });

            // 绑定处理按钮事件
            document.querySelectorAll('.process-refund').forEach(btn => {
                btn.addEventListener('click', function () {
                    const refundId = this.getAttribute('data-id');
                    openProcessRefundModal(refundId, refunds);
                });
            });

            // 更新分页
            renderRefundPagination(currentPage, totalPages);
        }

        // 渲染退款申请分页控件
        function renderRefundPagination(currentPage, totalPages) {
            console.log('渲染退款分页控件 - 当前页:', currentPage, '总页数:', totalPages);

            // 确保参数是数字
            currentPage = parseInt(currentPage) || 1;
            totalPages = parseInt(totalPages) || 1;

            const pagination = document.getElementById('refundPagination');
            pagination.innerHTML = '';

            // 如果总页数小于等于1，不显示分页
            if (totalPages <= 1) {
                console.log('退款总页数小于等于1，不显示分页');
                return;
            }

            // 创建一个简单的分页控件，避免过多的DOM操作
            let paginationHTML = '';

            // 上一页按钮
            paginationHTML += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="${currentPage > 1 ? `loadRefunds(${currentPage - 1})` : ''}">上一页</a>
                </li>
            `;

            // 第一页按钮（如果不在显示范围内）
            const maxPages = 5; // 最多显示5个页码
            let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages - 1);

            if (endPage - startPage + 1 < maxPages && startPage > 1) {
                startPage = Math.max(1, endPage - maxPages + 1);
            }

            if (startPage > 1) {
                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="javascript:void(0)" onclick="loadRefunds(1)">1</a>
                    </li>
                `;

                if (startPage > 2) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="javascript:void(0)">...</a>
                        </li>
                    `;
                }
            }

            // 页码按钮
            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="javascript:void(0)" ${i !== currentPage ? `onclick="loadRefunds(${i})"` : ''}>${i}</a>
                    </li>
                `;
            }

            // 最后一页按钮（如果不在显示范围内）
            if (endPage < totalPages) {
                // 如果结束页和最后一页之间有间隔，显示省略号
                if (endPage < totalPages - 1) {
                    paginationHTML += `
                        <li class="page-item disabled">
                            <a class="page-link" href="javascript:void(0)">...</a>
                        </li>
                    `;
                }

                paginationHTML += `
                    <li class="page-item">
                        <a class="page-link" href="javascript:void(0)" onclick="loadRefunds(${totalPages})">${totalPages}</a>
                    </li>
                `;
            }

            // 下一页按钮
            paginationHTML += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="javascript:void(0)" onclick="${currentPage < totalPages ? `loadRefunds(${currentPage + 1})` : ''}">下一页</a>
                </li>
            `;

            // 设置HTML
            pagination.innerHTML = paginationHTML;

            // 添加调试信息
            console.log('退款分页控件已渲染，当前页:', currentPage, '总页数:', totalPages);
        }

        // 打开退款处理模态框
        function openProcessRefundModal(refundId, refunds) {
            // 查找对应的退款申请
            const refund = refunds.find(r => r.refundId === refundId);
            if (!refund) {
                showAlert('error', '找不到对应的退款申请');
                return;
            }

            // 填充表单数据
            document.getElementById('refundId').value = refund.refundId;
            document.getElementById('refundOrderId').value = refund.orderId;
            document.getElementById('processRefundOrderId').textContent = refund.orderId;
            document.getElementById('processRefundUserId').textContent = refund.userId;

            // 处理金额显示
            let amountDisplay = '¥0.00';
            if (refund.amount !== undefined && refund.amount !== null) {
                amountDisplay = `¥${Number(refund.amount).toFixed(2)}`;
            } else if (refund.refundAmount !== undefined && refund.refundAmount !== null) {
                amountDisplay = `¥${Number(refund.refundAmount).toFixed(2)}`;
            }
            document.getElementById('processRefundAmount').textContent = amountDisplay;

            document.getElementById('processRefundReason').textContent = refund.reason || '未提供原因';
            document.getElementById('processRefundStatus').value = '';
            document.getElementById('processRefundRemarks').value = '';

            // 设置实际退款金额默认值为申请金额
            const requestedAmount = document.getElementById('processRefundAmount').textContent.replace('¥', '').trim();
            document.getElementById('actualRefundAmount').value = requestedAmount;

            // 初始状态下隐藏实际退款金额输入框
            document.getElementById('actualRefundAmountGroup').style.display = 'none';

            // 添加处理结果选择变化事件
            document.getElementById('processRefundStatus').addEventListener('change', function () {
                const status = this.value;
                const remarksLabel = document.querySelector('label[for="processRefundRemarks"]');
                const actualRefundAmountGroup = document.getElementById('actualRefundAmountGroup');

                if (status === 'APPROVED') {
                    remarksLabel.textContent = '处理备注';
                    actualRefundAmountGroup.style.display = 'block';
                } else if (status === 'REJECTED') {
                    remarksLabel.textContent = '拒绝原因 (必填)';
                    actualRefundAmountGroup.style.display = 'none';
                } else {
                    remarksLabel.textContent = '处理备注';
                    actualRefundAmountGroup.style.display = 'none';
                }
            });

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('processRefundModal'));
            modal.show();
        }

        // 提交退款处理结果
        function submitRefundProcess() {
            const refundId = document.getElementById('refundId').value;
            const orderId = document.getElementById('refundOrderId').value;
            const decision = document.getElementById('processRefundStatus').value;
            const remarks = document.getElementById('processRefundRemarks').value;

            // 表单验证
            if (!decision) {
                showAlert('error', '请选择处理结果');
                return;
            }

            // 如果是拒绝退款，必须提供拒绝原因
            if (decision === 'REJECTED' && !remarks.trim()) {
                showAlert('error', '拒绝退款时必须提供拒绝原因');
                return;
            }

            // 获取实际退款金额
            let refundAmount;
            if (decision === 'APPROVED') {
                refundAmount = document.getElementById('actualRefundAmount').value;
                if (!refundAmount || isNaN(parseFloat(refundAmount)) || parseFloat(refundAmount) <= 0) {
                    showAlert('error', '请输入有效的退款金额');
                    return;
                }
            }

            // 禁用提交按钮并显示加载状态
            const submitBtn = document.getElementById('submitProcessRefundBtn');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 处理中...`;

            // 构建请求数据
            const processData = {
                refundId: refundId,
                orderId: orderId,
                decision: decision,
                remarks: remarks
            };

            // 添加退款金额或拒绝原因
            if (decision === 'APPROVED') {
                processData.refundAmount = parseFloat(refundAmount);
            } else if (decision === 'REJECTED') {
                processData.rejectReason = remarks;
            }

            // 发送请求
            axios.post('/api/admin/orders/refunds/process', processData)
                .then(response => {
                    if (response.data.code === 200) {
                        showAlert('success', '退款申请处理成功');

                        // 关闭模态框
                        bootstrap.Modal.getInstance(document.getElementById('processRefundModal')).hide();

                        // 重新加载退款申请列表
                        loadRefunds(1);
                    } else {
                        showAlert('error', '处理退款申请失败: ' + response.data.message);

                        // 恢复按钮状态
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = originalText;
                    }
                })
                .catch(error => {
                    console.error('处理退款申请失败:', error);
                    showAlert('error', '处理退款申请失败，请稍后重试');

                    // 恢复按钮状态
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                });
        }
    </script>
</body>

</html>