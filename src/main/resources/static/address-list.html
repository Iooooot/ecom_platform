<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>地址管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 70px;
        }

        .navbar {
            background-color: #6c757d;
        }

        .navbar-brand,
        .nav-link {
            color: white !important;
        }

        .container {
            max-width: 900px;
        }

        .content-area {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-bottom: 20px;
        }

        .address-card {
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            position: relative;
        }

        .address-card.default {
            border-color: #28a745;
            background-color: #f8fff8;
        }

        .default-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #28a745;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .address-actions {
            margin-top: 15px;
        }
    </style>
</head>

<body>
    <!-- 导航栏容器 -->
    <div id="navbar-container"></div>

    <div class="container">
        <div id="alertContainer"></div>

        <!-- 内容区域 -->
        <div class="row">
            <div class="col-12">
                <div class="content-area">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>地址管理</h4>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addAddressModal">
                            <i class="bi bi-plus-circle"></i> 添加新地址
                        </button>
                    </div>

                    <div id="addressList">
                        <div class="text-center py-4">
                            <div class="spinner-border text-secondary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-2">正在加载地址...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加地址模态框 -->
    <div class="modal fade" id="addAddressModal" tabindex="-1" aria-labelledby="addAddressModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addAddressModalLabel">添加新地址</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="addressForm">
                        <input type="hidden" id="addressId" value="">
                        <div class="mb-3">
                            <label for="receiverName" class="form-label">收货人姓名</label>
                            <input type="text" class="form-control" id="receiverName" required>
                        </div>
                        <div class="mb-3">
                            <label for="receiverPhone" class="form-label">联系电话</label>
                            <input type="tel" class="form-control" id="receiverPhone" required>
                        </div>
                        <div class="mb-3">
                            <label for="province" class="form-label">省份</label>
                            <input type="text" class="form-control" id="province" required>
                        </div>
                        <div class="mb-3">
                            <label for="city" class="form-label">城市</label>
                            <input type="text" class="form-control" id="city" required>
                        </div>
                        <div class="mb-3">
                            <label for="district" class="form-label">区/县</label>
                            <input type="text" class="form-control" id="district" required>
                        </div>
                        <div class="mb-3">
                            <label for="detailAddress" class="form-label">详细地址</label>
                            <textarea class="form-control" id="detailAddress" rows="2" required></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="zipCode" class="form-label">邮政编码</label>
                            <input type="text" class="form-control" id="zipCode">
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="isDefault">
                            <label class="form-check-label" for="isDefault">设为默认地址</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveAddressBtn">保存</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="js/common.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 导航和用户信息由common.js处理
            
            // 添加地址模态框
            let addressModal = new bootstrap.Modal(document.getElementById('addAddressModal'));
            
            // 加载地址列表
            loadAddresses();
            
            // 保存地址按钮
            document.getElementById('saveAddressBtn').addEventListener('click', saveAddress);
        });

        // 加载地址列表
        function loadAddresses() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'auth.html';
                return;
            }

            axios.get('/api/addresses', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (response.data.code === 200) {
                    displayAddresses(response.data.data);
                } else {
                    showAlert('error', '加载地址失败: ' + response.data.message);
                }
            })
            .catch(error => {
                console.error('加载地址失败:', error);
                showAlert('error', '加载地址失败，请稍后重试');
            });
        }

        // 显示地址列表
        function displayAddresses(addresses) {
            const addressListContainer = document.getElementById('addressList');
            
            if (!addresses || addresses.length === 0) {
                addressListContainer.innerHTML = `
                    <div class="text-center py-4">
                        <i class="bi bi-geo-alt-fill text-secondary" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">您还没有添加收货地址</h5>
                        <p>添加地址以便我们将商品送达您手中</p>
                    </div>
                `;
                return;
            }
            
            addressListContainer.innerHTML = '';
            
            addresses.forEach(address => {
                const addressCard = document.createElement('div');
                addressCard.className = `address-card ${address.isDefault ? 'default' : ''}`;
                addressCard.innerHTML = `
                    ${address.isDefault ? '<span class="default-badge">默认</span>' : ''}
                    <div class="row">
                        <div class="col-md-6">
                            <div><strong>${address.receiverName}</strong> ${address.receiverPhone}</div>
                            <div class="text-muted">${address.province} ${address.city} ${address.district}</div>
                            <div>${address.detailAddress}</div>
                            ${address.zipCode ? `<div class="text-muted">邮编: ${address.zipCode}</div>` : ''}
                        </div>
                        <div class="col-md-6">
                            <div class="address-actions d-flex justify-content-end">
                                <button class="btn btn-sm btn-outline-primary me-2 edit-btn" data-address-id="${address.id}">
                                    <i class="bi bi-pencil"></i> 编辑
                                </button>
                                ${!address.isDefault ? 
                                    `<button class="btn btn-sm btn-outline-success me-2 set-default-btn" data-address-id="${address.id}">
                                        <i class="bi bi-check-circle"></i> 设为默认
                                    </button>` : ''
                                }
                                <button class="btn btn-sm btn-outline-danger delete-btn" data-address-id="${address.id}">
                                    <i class="bi bi-trash"></i> 删除
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                addressListContainer.appendChild(addressCard);
            });
            
            // 添加编辑按钮事件
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressId = this.getAttribute('data-address-id');
                    editAddress(addressId);
                });
            });
            
            // 添加设为默认按钮事件
            document.querySelectorAll('.set-default-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressId = this.getAttribute('data-address-id');
                    setDefaultAddress(addressId);
                });
            });
            
            // 添加删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const addressId = this.getAttribute('data-address-id');
                    deleteAddress(addressId);
                });
            });
        }

        // 编辑地址
        function editAddress(addressId) {
            const token = localStorage.getItem('token');
            
            axios.get(`/api/addresses/${addressId}`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (response.data.code === 200) {
                    const address = response.data.data;
                    
                    // 填充表单
                    document.getElementById('addressId').value = address.id;
                    document.getElementById('receiverName').value = address.receiverName;
                    document.getElementById('receiverPhone').value = address.receiverPhone;
                    document.getElementById('province').value = address.province;
                    document.getElementById('city').value = address.city;
                    document.getElementById('district').value = address.district;
                    document.getElementById('detailAddress').value = address.detailAddress;
                    document.getElementById('zipCode').value = address.zipCode || '';
                    document.getElementById('isDefault').checked = address.isDefault;
                    
                    // 显示模态框
                    document.getElementById('addAddressModalLabel').textContent = '编辑地址';
                    new bootstrap.Modal(document.getElementById('addAddressModal')).show();
                } else {
                    showAlert('error', '获取地址信息失败: ' + response.data.message);
                }
            })
            .catch(error => {
                console.error('获取地址信息失败:', error);
                showAlert('error', '获取地址信息失败，请稍后重试');
            });
        }

        // 设为默认地址
        function setDefaultAddress(addressId) {
            const token = localStorage.getItem('token');
            
            axios.put(`/api/addresses/${addressId}/default`, {}, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (response.data.code === 200) {
                    showAlert('success', '默认地址设置成功');
                    loadAddresses();
                } else {
                    showAlert('error', '设置默认地址失败: ' + response.data.message);
                }
            })
            .catch(error => {
                console.error('设置默认地址失败:', error);
                showAlert('error', '设置默认地址失败，请稍后重试');
            });
        }

        // 删除地址
        function deleteAddress(addressId) {
            if (confirm('确定要删除此地址吗？')) {
                const token = localStorage.getItem('token');
                
                axios.delete(`/api/addresses/${addressId}`, {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                })
                .then(response => {
                    if (response.data.code === 200) {
                        showAlert('success', '地址删除成功');
                        loadAddresses();
                    } else {
                        showAlert('error', '删除地址失败: ' + response.data.message);
                    }
                })
                .catch(error => {
                    console.error('删除地址失败:', error);
                    showAlert('error', '删除地址失败，请稍后重试');
                });
            }
        }

        // 保存地址
        function saveAddress() {
            const token = localStorage.getItem('token');
            const addressId = document.getElementById('addressId').value;
            
            const addressData = {
                receiverName: document.getElementById('receiverName').value,
                receiverPhone: document.getElementById('receiverPhone').value,
                province: document.getElementById('province').value,
                city: document.getElementById('city').value,
                district: document.getElementById('district').value,
                detailAddress: document.getElementById('detailAddress').value,
                zipCode: document.getElementById('zipCode').value,
                isDefault: document.getElementById('isDefault').checked
            };
            
            // 验证必填字段
            if (!addressData.receiverName || !addressData.receiverPhone || 
                !addressData.province || !addressData.city || 
                !addressData.district || !addressData.detailAddress) {
                showAlert('error', '请填写所有必填字段');
                return;
            }
            
            const url = addressId ? `/api/addresses/${addressId}` : '/api/addresses';
            const method = addressId ? 'put' : 'post';
            
            axios({
                method: method,
                url: url,
                data: addressData,
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
            .then(response => {
                if (response.data.code === 200) {
                    showAlert('success', addressId ? '地址更新成功' : '地址添加成功');
                    
                    // 隐藏模态框
                    const addressModal = bootstrap.Modal.getInstance(document.getElementById('addAddressModal'));
                    addressModal.hide();
                    
                    // 重置表单
                    document.getElementById('addressForm').reset();
                    document.getElementById('addressId').value = '';
                    document.getElementById('addAddressModalLabel').textContent = '添加新地址';
                    
                    // 重新加载地址列表
                    loadAddresses();
                } else {
                    showAlert('error', (addressId ? '更新' : '添加') + '地址失败: ' + response.data.message);
                }
            })
            .catch(error => {
                console.error((addressId ? '更新' : '添加') + '地址失败:', error);
                showAlert('error', (addressId ? '更新' : '添加') + '地址失败，请稍后重试');
            });
        }
    </script>
</body>

</html>